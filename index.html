<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Employee Rating Matrix</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="app-container">

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.16/browser.js"></script>
    <script src="js/dist.js"></script>
    <script src="js/data.js"></script>
    <script src="js/reducers.js"></script>
    <script src="js/tests.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.5.2/redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script type="text/babel">
      var ScoreCardItem = React.createClass({
        render: function(){
          return (
            <div className="sc-item">
              <div className="sc-name">
                {this.props.item.name}
              </div>
              <div className="sc-score">
                {this.props.item.score}
              </div>
              <div className="sc-weight">
                {this.props.item.weight}
              </div>
            </div>
          );
        }
      });
      var ScoreCardPanel = React.createClass({
        render: function(){
          var scoreCardItems = this.props.scorecard.map( (e) =>
            <ScoreCardItem item={e} key={generateId(e.name)}></ScoreCardItem>
          );
          return (
            <div>
              {scoreCardItems}
            </div>
          );
        }
      });
      var CoreValueItem = React.createClass({
        _handleCoreValChange: function(e){
          store.dispatch({
            type: 'COREVAL_CHANGE', employee: this.props.employee,
            newVal: e.target.value, k: this.props.k
          });
        },
        render: function(){
            return (
              <li className="core-li" key={this.props.k}>
                {this.props.k}<br />
                <input type="number" min="1" max="10" value={this.props.val}
                keyName={this.props.k} onChange={this._handleCoreValChange} />
              </li>
            );
        }
      });
      var EvaluationPanel = React.createClass({
        render: function(){
          var corevalz = [];
          for (var k in this.props.coreVals){
            corevalz.push( <CoreValueItem key={k} k={k}
              employee={this.props.name} val={this.props.coreVals[k]}></CoreValueItem> );
          }
          return (
            <div>
              <h1>{this.props.name}</h1>
              <h2>Core Values</h2>
              <ul className="core-values-panel">
                {corevalz}
              </ul>
              <hr />
              <h2>Score Card</h2>
              <ScoreCardPanel employee={this.props.name}
              scorecard={this.props.scorecard}></ScoreCardPanel>
            </div>

          )
        }
      });
      var SCInput = React.createClass({
        /*_handleOnChange: function(e){
          var curIDStub = e.target.id.substring(0, e.target.id.length-1);
          var curID = Number(e.target.id.substring(e.target.id.length-1));
          if (e.target.value.length === 0){
            $(e.target).siblings().toArray().reverse().reduce( (p, c, i) => {
              if (p === i && $(c).val().length === 0 ){
                $(c).addClass("hidden");
                return p+1;
              }else{
                return p;
              }
            }, 0);
          }
          else{
            //unhide next one
            $(`#${curIDStub}${curID+1}`).removeClass('hidden');
          }
        },*/
        render: function(){
          var cls = this.props.k!=0?"block-input":"block-input";
          var id = `sc-item-${this.props.k}`;
          return (
            <input type="text" className={cls} id={id} ref={ (input) => this.input = input }/>
          );
        }
      });
      var EvaluationCreator = React.createClass({
        _createEval: function(){
          let scorecard = [];
          for (var k in this.inputs){
            var txtVal = this.inputs[k].input.value;
            if (txtVal.length > 0){
              scorecard.push({
                name: txtVal,
                score: 0,
                weight: 0
              });
            }
          }
          let name = this.name.value;
          const action = {
            type: "ADD_EVAL",
            sc:{ name, scorecard }
          };
          //here we dispatch:
          store.dispatch(action);
          this._reset();
        },
        _reset: function(){
          for (var k in this.inputs){
            this.inputs[k].input.value = "";
          }
          this.name.value = "";
        },
        componentWillMount: function(){
          this.inputs = {};
        },
        render: function(){
          var inputs = Array(6).fill(1).map( (e,i) => i ).map( (elm,idx) => {
            return (
              <SCInput key={elm} k={elm} ref={ (ref) => this.inputs[idx] = ref }/>
            );
          } );
          return (
            <div className='add-panel'>
              <h1>Create New Evaluation</h1>
              <span>Employee Name: </span>
              <input type="text" id="new-name" ref={ (ref) => this.name = ref }/>
              <div>Employee Scorecard Items: </div>
              <div>
                {inputs}
              </div>
              <div className="btn" onClick={this._createEval}>
                Create new Scorecard
              </div>
            </div>
          );
        }
      });
      var EvaluationList = React.createClass({
          render: function(){
            var selfProps = this.props;
            var evaluationPanels = this.props.evals.map(function(e){
              return (
                <EvaluationPanel key={generateId(e.name)} name={e.name}
                  scorecard={e.scorecard} coreVals={e.coreVals} />
                );
            });
            return (
              <div className="evaluation-list-row">
                {evaluationPanels}
              </div>
            );
          }
        });
        var EvaluationApp = React.createClass({
          getInitialState: function(){
            return {
              coreVals:coreValues,
              evals:evals
            };
            //console.log(store.getState());
            //return store.getState();
          },
          render: function(){
            return (
              <div>
                <EvaluationList coreVals={store.getState().coreValues} evals={store.getState().evals}  />
                <EvaluationCreator />
              </div>

            );
          }
        });
        const { createStore } = Redux;
        const store = createStore(reducer);
        const render = () =>{
          ReactDOM.render(
            <EvaluationApp />,
            document.getElementById("app-container")
          );
        };
        store.subscribe(render);
        render();

    </script>
  </body>
</html>
