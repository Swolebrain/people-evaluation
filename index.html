<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Employee Rating Matrix</title>
    <link rel="shortcut icon" type="image/ico" href="http://www.fvi.edu/wp-content/themes/fvi/images/fav.ico" />
    <link href='https://fonts.googleapis.com/css?family=Lato|Catamaran:700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <img id="logo" src="img/FVI-white.png" alt="Florida Vocational Institute" class="center-block"/>
    <h1 class="center-block white-text">People Plotting Grid</h1>
    <div id="app-container">

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.16/browser.js"></script>
    <script src="js/dist.js"></script>
    <script src="js/data.js"></script>
    <script src="js/reducers.js"></script>
    <script src="js/tests.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.5.2/redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script type="text/babel">
      const PANELWIDTH = 370;
      var EvaluationGrid = React.createClass({
        getInitialState: function(){
          return {visible: false};
        },
        generateGrid: function(){
          var gridPositions = this.props.evals.reduce( (prev,ev) => {
              var name = ev.name;
              var scorecard = Math.round(ev.scorecard.reduce( (p,c) => p+(c.score*c.weight) , 0));
              var coreVals = Math.round(Object.keys(ev.coreVals).reduce( (p,c) => p+ ev.coreVals[c] , 0)/
                                              Object.keys(ev.coreVals).length);
              return prev.concat({name, scorecard, coreVals});
          }, []);
          var grid = [ ["", "", "", "", "", ""], ["", "", "", "", "", ""], ["", "", "", "", "", ""],
                ["", "", "", "", "", ""], ["", "", "", "", "", ""], ["", "", "", "", "", ""] ];

          gridPositions.forEach( (e, idx) => {
            var row = 10-e.scorecard;
            if (row < 0) row = 0;
            if (row > 5) row = 5;
            var col = e.coreVals-5;
            if (col < 0) col = 0;
            grid[row][col] += e.name+'\n';
          });
          var rows = grid.map( function(row, index){
            var cells = row.map( (e, i) => <td key={i}> {e} </td>);
            return (
              <tr key={index}>
                {cells}
              </tr>);
            });
          return (
            <div>
              <table>
                <tbody>
                  {rows}
                </tbody>
              </table>
            </div>
          );
        },
        _hideOverlay: function(){
          //set state to hidden
          this.setState({visible: false});
        },
        _reveal: function(){
          console.log("revealing");
          this.setState({visible: true});
        },
        render: function(){
          var style = {marginBottom: "20px"};
          var overlayStyle = {height: $(document).height()};
          var overlay = <div></div>;
          if (this.state.visible){
            overlay = (
            <div className='overlay' style={overlayStyle} onClick={this._hideOverlay}>
              {this.generateGrid()}
            </div>);
          }
          return (
            <div>
              <div className="btn center-block" style={style} onClick={this._reveal}>
                Plot Grid!
              </div>
              {overlay}
            </div>

          );
        }
      });

      var CoreValsReminder = React.createClass({
        render: function(){
          var rows = [];
          for (var k in this.props.coreVals){
            rows.push(
              <li className="li-pad" key={k}>
                <strong>{k}: </strong> {this.props.coreVals[k]}
              </li>
            );
          }
          return (
            <div className="core-vals-reminder">
              <h2>Our Core Values:</h2>
              <ul>
                {rows}
              </ul>

            </div>
          );
        }
      });
      var ScoreCardItem = React.createClass({
        _handleSCScoreChange: function(e){
          store.dispatch({type: 'SC_SCORE_CHANGE',
                        employee: this.props.employee,
                        newVal: e.target.value,
                        k: this.props.item.name});
        },
        _handleSCWeightChange: function(e){
          //TODO: ENFORCE WEIGHTS ADDING UP TO 1, JUST RED CSS BORDER
          store.dispatch({type: 'SC_WEIGHT_CHANGE',
                        employee: this.props.employee,
                        newVal: e.target.value,
                        k: this.props.item.name});
        },
        render: function(){
          return (
            <div className="sc-item">
              <div className="sc-name">
                {this.props.item.name}
              </div>
              <div className="sc-score">
                <input type="number" value={this.props.item.score} onChange={this._handleSCScoreChange} />
              </div>
              <div className="sc-weight">
                <input type="number" min="0" max="1" step="0.1"
                value={this.props.item.weight} onChange={this._handleSCWeightChange} />
              </div>
            </div>
          );
        }
      });
      var ScoreCardPanel = React.createClass({
        render: function(){
          var scoreCardItems = this.props.scorecard.map( (e) =>
            <ScoreCardItem employee={this.props.employee} item={e} key={generateId(e.name)}></ScoreCardItem>
          );
          return (
            <div>
              {scoreCardItems}
            </div>
          );
        }
      });
      var CoreValueItem = React.createClass({
        _handleCoreValChange: function(e){
          store.dispatch({
            type: 'COREVAL_CHANGE', employee: this.props.employee,
            newVal: e.target.value, k: this.props.k
          });
        },
        render: function(){
            return (
              <li className="core-li" key={this.props.k}>
                {this.props.k}<br />
                <input type="number" min="1" max="10" value={this.props.val}
                keyName={this.props.k} onChange={this._handleCoreValChange} />
              </li>
            );
        }
      });
      var EvaluationPanel = React.createClass({
        _mount: function(){
          var width = (window.innerWidth-PANELWIDTH-30)/(store.getState().evals.length-1);
          var left = Math.min(parseInt(width)*this.props.index, PANELWIDTH*this.props.index);
          this._style = {left: left,
                      zIndex: this.props.index,
                      transform: "perspective(2000px) rotate3d(0,1,0,1deg)"};
          this.state = Object.assign({}, this._style);
        },
        componentWillMount: function(){
          //this._mount();
          /*var self = this;
          window.addEventListener('resize', function(){
              self._mount();
              self.setState(Object.assign({}, this.state));
          });*/
          //this._style = this.props.styleProp;
          //this.state = Object.assign({}, this._style);
          this._hovered = false;
        },
        _handleMouseEnter: function(){
          //this.setState({left: this._style.left, zIndex: 99, transform: "scale(1.05,1.05)"});
          this._hovered = true;
          this.setState({num: Math.random()});
        },
        _handleMouseLeave: function(){
          //this.setState(Object.assign({}, this._style));
          this._hovered = false;
          this.setState({num: Math.random()});
        },
        _removeEval: function(e){
          store.dispatch({
            type: 'REMOVE_EVAL',
            employee: this.props.name
          });
        },
        render: function(){
          var corevalz = [];
          for (var k in this.props.coreVals){
            corevalz.push( <CoreValueItem key={k} k={k}
              employee={this.props.name} val={this.props.coreVals[k]}></CoreValueItem> );
          }
          var localStyle;
          if (this._hovered){
            localStyle = { left: this.props.styleProp.left, zIndex: 99,
                        transform: "scale(1.05,1.05)" };
          }
          else{
            localStyle = this.props.styleProp;
          }
          return (
            <div className="employee-panel" style={localStyle}
                    onMouseEnter={this._handleMouseEnter} onMouseLeave={this._handleMouseLeave}>
              <span className="close-btn" onClick={this._removeEval}>X</span>
              <h1>{this.props.name}</h1>
              <h2>Core Values</h2>
              <ul className="core-values-panel">
                {corevalz}
              </ul>
              <hr />
              <h2>Score Card</h2>
              <ScoreCardPanel employee={this.props.name}
              scorecard={this.props.scorecard}></ScoreCardPanel>
            </div>

          )
        }
      });
      var SCInput = React.createClass({
        /*_handleOnChange: function(e){
          var curIDStub = e.target.id.substring(0, e.target.id.length-1);
          var curID = Number(e.target.id.substring(e.target.id.length-1));
          if (e.target.value.length === 0){
            $(e.target).siblings().toArray().reverse().reduce( (p, c, i) => {
              if (p === i && $(c).val().length === 0 ){
                $(c).addClass("hidden");
                return p+1;
              }else{
                return p;
              }
            }, 0);
          }
          else{
            //unhide next one
            $(`#${curIDStub}${curID+1}`).removeClass('hidden');
          }
        },*/
        render: function(){
          var cls = this.props.k!=0?"block-input":"block-input";
          var id = `sc-item-${this.props.k}`;
          return (
            <input type="text" className={cls} id={id} ref={ (input) => this.input = input }/>
          );
        }
      });
      var EvaluationCreator = React.createClass({
        _createEval: function(){
          let scorecard = [];
          for (var k in this.inputs){
            var txtVal = this.inputs[k].input.value;
            if (txtVal.length > 0){
              scorecard.push({
                name: txtVal,
                score: 0,
                weight: 0
              });
            }
          }
          let name = this.name.value;
          const action = {
            type: "ADD_EVAL",
            sc:{ name, scorecard }
          };
          //here we dispatch:
          store.dispatch(action);
          this._reset();
        },
        _reset: function(){
          for (var k in this.inputs){
            this.inputs[k].input.value = "";
          }
          this.name.value = "";
        },
        componentWillMount: function(){
          this.inputs = {};
        },
        render: function(){
          var inputs = Array(6).fill(1).map( (e,i) => i ).map( (elm,idx) => {
            return (
              <SCInput key={elm} k={elm} ref={ (ref) => this.inputs[idx] = ref }/>
            );
          } );
          return (
            <div className='add-panel'>
              <h1>Add Employee Evaluation</h1>
              <div>Employee Name: </div>
              <input type="text" className="block-input" id="new-name" ref={ (ref) => this.name = ref }/>
              <div>Employee Scorecard Items: </div>
              <div>
                {inputs}
              </div>
              <div className="btn" onClick={this._createEval}>
                Create new Scorecard
              </div>
            </div>
          );
        }
      });
      var EvaluationList = React.createClass({
        render: function(){
          var selfProps = this.props;
          var width = (window.innerWidth-PANELWIDTH-30)/(store.getState().evals.length-1);
          var rot = parseInt(45*this.props.evals.length/5); //dampen rotation the fewer elements there are
          var evaluationPanels = this.props.evals.map(function(e, idx, arr){
            var left = Math.min(parseInt(width)*idx, PANELWIDTH*idx);
            var styleProp = {left: left,
                        zIndex: idx,
                        transform: `perspective(2000px) rotate3d(0,1,0,${rot}deg)`};
            return (
              <EvaluationPanel key={generateId(e.name)} name={e.name} index={idx} styleProp={styleProp}
                scorecard={e.scorecard} coreVals={e.coreVals} />
              );
          });
          return (
            <div className="evaluation-list-row">
              {evaluationPanels}
            </div>
          );
        }
      });
      var EvaluationApp = React.createClass({
        getInitialState: function(){
          return {
            coreVals:coreValues,
            evals:evals
          };
          //console.log(store.getState());
          //return store.getState();
        },
        render: function(){
          return (
            <div>
              <EvaluationList coreVals={store.getState().coreValues} evals={store.getState().evals}  />
              <div>
                <EvaluationGrid evals={store.getState().evals} />
              </div>
              <div className="bottom-section">
                <EvaluationCreator />
                <CoreValsReminder coreVals={store.getState().coreValues} />
              </div>
            </div>

          );
        }
      });
      const { createStore } = Redux;
      const store = createStore(reducer);
      if ( localStorage.getItem("state") )
        store.dispatch({type: "HYDRATE", newState: JSON.parse(localStorage.getItem("state"))});
      const render = () =>{
        ReactDOM.render(
          <EvaluationApp />,
          document.getElementById("app-container")
        );
      };
      store.subscribe(render);
      store.subscribe( () => localStorage.setItem("state", JSON.stringify(store.getState())));
      render();

    </script>
  </body>
</html>
